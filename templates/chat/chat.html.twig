{% extends 'base.html.twig' %}

{% block title %}Chat!{% endblock %}

{% block body %}
<body class="d-flex justify-content-center align-items-center vh-100">
    <div class="w-400 h-60 shadow p-4 rounded">
        <a href="{{ path('home') }}" class="fs-4 link-dark">&#8592;</a>

        <div class="d-flex align-items-center">

            <div class="upload d-flex align-content-end" id="upload">

                <label for="form_upload_add_file" class="file-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
                        <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0V3z"/>
                        </svg>
                </label>
                <div class="input_div">
                    {{ form_start(uploadForm, {'action': path('upload')}) }}
                        {{ form_row(uploadForm.file, {'attr':{'data-action': path('upload')}}) }}
                        {{ form_rest(uploadForm) }}
                    {{ form_end(uploadForm) }}
                </div>
            </div>

            <h3 class="fs-xs m-2">
                {{ conversation[0].name }}
                <div class="d-flex align-items-center" title="online">
                    {% if (lastSeen == "Active") %}
                        <div class="online"></div>
                        <small class="d-block p-1">En Ligne</small>
                    {% else %}
                        <small class="d-block p-1">
                            Dernier message :
                            {{ lastSeen }}
                        </small>
                    {% endif %}
                </div>
            </h3>

        </div>

        <div class="shadow p-4 h-60 rounded d-flex flex-column mt-2 chat-box" id="chatBox">
            {% if chats %}
                {% for Chat in chats %}
                    {% if chat.AppUser == User %}

                        <p class="rtext align-self-end border rounded p-2 mb-1 a">
                            {% if(chat.Message|slice(0, 4) == 'img:' ) %}
                                <img src="{{ asset(chat.Message|slice(4))}}" class="rtext"/>
                            {% elseif (Chat.Message|slice(0, 5) == 'file:')%}
                                <a href="{{ asset(chat.Message|slice(5))}}" download='' class='a'>Télécharger <i class='fas fa-download'></i></a>
                            {% else %}
                                {{ Chat.Message }}
                            {% endif %}
                            <small class="d-block">
                                <b>{{ user.Name }} {{ user.Lastname }}</b>
                                <br>
                                {{ chat.CreatedAt|format_datetime('short', 'short', locale='fr') }}
                            </small>
                        </p>

                    {% else %}

                        <p class="ltext align-self-start border rounded p-2 mb-1">
                            {% if(chat.Message|slice(0, 4) == 'img:' ) %}
                                <img src="{{ asset(chat.Message|slice(4))}}" class="ltext"/>
                            {% elseif (chat.Message|slice(0, 5) == 'file:')%}
                                <a href="{{ asset(chat.Message|slice(5))}}" download='' class='a'>Télécharger <i class='fas fa-download'></i></a>
                            {% else %}
                                {{ chat.Message }}
                            {% endif %}
                            <small class="d-block">
                                <b>{{ chat.AppUser.Name }} {{ chat.AppUser.Lastname }}</b>
                                <br>
                                {{ chat.CreatedAt|format_datetime('short', 'short', locale='fr') }}
                            </small>
                        </p>

                    {% endif %}
                {% endfor %}
            {% else %}
                <div class="alert alert-info text-center">
                    <i class="fa fa-comments d-block fs-big"></i>
                    Pas de message pour l'instant, commencer la conversation !
                </div>
            {% endif %}
        </div>
        <div class="input-group mb-3" >
            <textarea cols="3" id="Message" class="form-control"></textarea>
            <button class="btn btn-primary" id="sendBtn" type="submit">
                <i class="fa fa-paper-plane"></i>
            </button>
        </div>

        <div id="ChatInfo"></div>
    </div>

    {% block javascripts %}
        <script src="{{ asset('assets/js/Chat.js') }}"></script>
        <script>
            Chat.init({{ user.id }}, {{ conversation[0].id }}, "{{ user.Name }}", "{{ user.Lastname }}");
        </script>
    {% endblock javascripts%}


</body>
{% endblock %}

